<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Frame VR Playground</title>
    
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- A-Frame Extras for additional components -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <!-- Monaco Editor -->
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            color: #fff;
        }
        
        .header {
            background: #2d2d30;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #3e3e42;
            min-height: 40px;
        }
        
        .menu-btn {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .menu-btn:hover {
            background: #ff8c1a;
        }
        
        .menu-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .main-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }
        
        .editor-container {
            width: 0%;
            background: #1e1e1e;
            border-right: 1px solid #3e3e42;
            position: relative;
            overflow: hidden;
            transition: width 0.3s ease-in-out;
        }

        .editor-container.open {
            width: 100%;
        }

        .scene-container {
            width: 100%;
            background: #252526;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 0.3s ease-in-out;
        }

        .scene-container.editor-open {
            width: 0%;
        }

        .editor-toggle-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            padding: 12px 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            z-index: 20;
            transition: all 0.3s ease-in-out;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .editor-toggle-btn:hover {
            background: #ff8c1a;
        }

        .editor-toggle-btn:active {
            background: #ff5722;
        }

        /* When editor is open, button moves to right edge */
        .editor-toggle-btn.editor-open {
            left: auto;
            right: 0;
            border-radius: 4px 0 0 4px;
        }
        
        .footer {
            background: #ff6b35;
            padding: 4px 12px;
            font-size: 11px;
            text-align: center;
            color: white;
        }
        
        .error-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f14c4c;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            display: none;
            z-index: 1000;
        }
        
        /* Floating Console Window */
        .console-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 300px;
            background: #1e1e1e;
            border: 1px solid #ff6b35;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            resize: both;
            overflow: hidden;
            min-width: 300px;
            min-height: 200px;
            max-width: 90vw;
            max-height: 80vh;
            transition: opacity 0.2s;
        }

        .console-window.hidden {
            display: none;
        }

        .console-window.minimized .console-content {
            display: none;
        }

        .console-window.minimized {
            height: auto !important;
            min-height: auto;
            resize: none;
        }

        .console-window.minimized .console-resize-handle {
            display: none;
        }

        .console-title-bar {
            background: #2d2d30;
            padding: 8px 12px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ff6b35;
            user-select: none;
        }

        .console-title {
            font-weight: 600;
            font-size: 13px;
            color: #cccccc;
        }

        .console-controls {
            display: flex;
            gap: 4px;
        }

        .console-btn {
            background: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 14px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .console-btn:hover {
            background: rgba(255, 107, 53, 0.2);
        }

        .console-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 8px;
            font-size: 11px;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #ccc;
            user-select: text;
            -webkit-user-select: text;
            cursor: text;
        }

        .console-message {
            margin: 2px 0;
            word-wrap: break-word;
            white-space: pre-wrap;
            user-select: text;
            -webkit-user-select: text;
        }

        .console-error {
            color: #f14c4c;
        }

        .console-warning {
            color: #ffcc02;
        }

        .console-log {
            color: #ccc;
        }

        .console-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            background: linear-gradient(135deg, transparent 50%, #ff6b35 50%);
        }

        /* Console Open Button */
        .console-open-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 1500;
            transition: all 0.2s;
        }

        .console-open-btn:hover {
            background: #ff8552;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .console-open-btn:active {
            transform: scale(0.95);
        }

        .console-open-btn.hidden {
            display: none;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #cccccc;
            font-size: 14px;
        }
        
        /* A-Frame Scene Styling */
        a-scene {
            width: 100%;
            height: 100%;
        }
        
        /* Remove media query - same behavior across all devices per requirements */
        /* The editor starts hidden (width: 0%) on all screen sizes */
    </style>
</head>
<body>
    <div class="header">
        <button class="menu-btn" onclick="runCode()">‚ñ∂ Run</button>
        <button class="menu-btn" onclick="formatCode()">{ } Format</button>
        <button class="menu-btn" onclick="clearCode()">üóë Clear</button>
        <button class="menu-btn" onclick="saveScene()">üíæ Save</button>
        <button class="menu-btn" onclick="downloadScene()">‚¨á Download</button>
        <button class="menu-btn" onclick="newScene()">üìÑ New</button>
        <button class="menu-btn" onclick="showExamples()">üìö Examples</button>
        <button class="menu-btn" onclick="toggleConsole()">üñ• Console</button>
        <select class="menu-btn" onchange="loadExample(this.value)">
            <option value="">Select Example...</option>
            <option value="basic-vr">Basic VR Scene</option>
            <option value="interactive">Interactive Objects</option>
            <option value="animation">Animation Demo</option>
            <option value="vr-controls">VR Controllers</option>
        </select>
    </div>
    
    <div class="main-container">
        <div class="editor-container" id="editorContainer">
            <div id="monaco-editor" style="width: 100%; height: 100%;"></div>
            <button class="console-open-btn" id="consoleOpenBtn" title="Open Console">üìü</button>
        </div>
        <div class="scene-container" id="sceneContainer">
            <button class="editor-toggle-btn" id="editorToggleBtn" onclick="toggleEditor()">CODE</button>
            <div id="aframe-container" style="width: 100%; height: 100%;">
                <div class="loading" id="loading">Loading A-Frame...</div>
            </div>
        </div>
    </div>

    <div class="footer">
        A-Frame VR Playground - Powered by WebXR
    </div>

    <div class="error-display" id="errorDisplay"></div>

    <!-- Floating Console Window -->
    <div class="console-window" id="consoleWindow">
        <div class="console-title-bar" id="consoleTitleBar">
            <div class="console-title">Console</div>
            <div class="console-controls">
                <button class="console-btn" id="consoleMinimizeBtn" title="Minimize">‚àí</button>
                <button class="console-btn" id="consoleToggleBtn" title="Expand">‚Üï</button>
                <button class="console-btn" id="consoleCloseBtn" title="Close">√ó</button>
            </div>
        </div>
        <div class="console-content" id="consoleContent"></div>
        <div class="console-resize-handle" id="consoleResizeHandle"></div>
    </div>

    <script>
        let editor;
        let currentScene;
        let isResizing = false;
        let consoleMessages = [];
        let isEditorOpen = false;
        let consoleState = {
            x: null,
            y: null,
            width: 400,
            height: 300,
            minimized: false,
            hidden: false
        };

        // Editor toggle functionality - switches between code view (100%) and scene view (100%)
        function toggleEditor() {
            isEditorOpen = !isEditorOpen;
            const editorContainer = document.getElementById('editorContainer');
            const sceneContainer = document.getElementById('sceneContainer');
            const toggleBtn = document.getElementById('editorToggleBtn');

            if (isEditorOpen) {
                // Show code editor (100%), hide scene (0%)
                editorContainer.classList.add('open');
                sceneContainer.classList.add('editor-open');
                toggleBtn.classList.add('editor-open');
                toggleBtn.textContent = 'SCENE';

                // Trigger Monaco layout after transition completes
                setTimeout(() => {
                    if (editor && typeof editor.layout === 'function') {
                        editor.layout();
                    }
                }, 300);
            } else {
                // Show scene (100%), hide code editor (0%)
                editorContainer.classList.remove('open');
                sceneContainer.classList.remove('editor-open');
                toggleBtn.classList.remove('editor-open');
                toggleBtn.textContent = 'CODE';
            }
        }
        
        // Override console methods to capture logs
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };
        
        console.log = (...args) => {
            originalConsole.log(...args);
            addConsoleMessage('log', args.map(arg => String(arg)).join(' '));
        };
        
        console.error = (...args) => {
            originalConsole.error(...args);
            addConsoleMessage('error', args.map(arg => String(arg)).join(' '));
        };
        
        console.warn = (...args) => {
            originalConsole.warn(...args);
            addConsoleMessage('warning', args.map(arg => String(arg)).join(' '));
        };
        
        console.info = (...args) => {
            originalConsole.info(...args);
            addConsoleMessage('log', args.map(arg => String(arg)).join(' '));
        };
        
        // Initialize Monaco Editor with enhanced error handling and fallback
        console.log('Starting Monaco Editor initialization for A-Frame...');
        
        // Set longer timeout for CDN loading
        let monacoTimeout = setTimeout(() => {
            console.error('‚ùå Monaco Editor CDN loading timeout - creating fallback editor');
            createFallbackEditor();
        }, 10000); // 10 second timeout
        
        require.config({ 
            paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' },
            waitSeconds: 30 // Increase wait time for CDN
        });
        
        require(['vs/editor/editor.main'], function () {
            clearTimeout(monacoTimeout); // Cancel timeout since loading succeeded
            console.log('‚úÖ Monaco modules loaded successfully, creating A-Frame editor...');
            
            try {
                editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                    value: getDefaultCode(),
                    language: 'html',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: { enabled: true },
                    fontSize: 14,
                    wordWrap: 'on',
                    scrollBeyondLastLine: false,
                    renderLineHighlight: 'all',
                    selectionHighlight: false,
                    lineNumbers: 'on',
                    glyphMargin: true,
                    folding: true,
                    foldingStrategy: 'indentation',
                    showFoldingControls: 'always',
                    unfoldOnClickAfterEndOfLine: false,
                    tabSize: 2
                });
                
                console.log('‚úÖ Monaco editor created successfully:', !!editor);
                
                // Auto-save on changes
                editor.onDidChangeModelContent(() => {
                    debounce(notifyCodeChange, 500)();
                });
                
                // Make editor globally accessible
                window.editor = editor;
                window.monacoEditor = editor;
                window.codeEditor = editor;
                
                // Enhanced readiness check with multiple verification steps
                function verifyAndMarkReady() {
                    console.log('üîç Verifying Monaco editor readiness for A-Frame...');
                    console.log('- Editor instance:', !!editor);
                    console.log('- Editor model:', !!editor.getModel());
                    console.log('- setValue function:', typeof editor.setValue === 'function');
                    console.log('- getValue function:', typeof editor.getValue === 'function');
                    console.log('- DOM ready:', document.readyState);
                    
                    if (editor && editor.getModel && 
                        typeof editor.setValue === 'function' && 
                        typeof editor.getValue === 'function') {
                        
                        // Final functional test
                        try {
                            const testContent = editor.getValue();
                            editor.layout(); // Trigger layout calculation
                            console.log('‚úÖ Monaco functional test passed - content length:', testContent.length);
                            
                            // Mark as ready
                            window.editorReady = true;
                            console.log('üéØ MONACO EDITOR MARKED AS READY FOR INJECTION');
                            
                            // Initialize A-Frame after Monaco is confirmed ready
                            initializeAFrame();
                            
                        } catch (testError) {
                            console.error('‚ùå Monaco functional test failed:', testError);
                            setTimeout(verifyAndMarkReady, 500); // Retry
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Monaco not fully ready yet, retrying...');
                        setTimeout(verifyAndMarkReady, 500); // Retry
                    }
                }
                
                // Start verification process with initial delay
                setTimeout(verifyAndMarkReady, 1000);
                
            } catch (editorError) {
                console.error('‚ùå Failed to create Monaco editor:', editorError);
                createFallbackEditor();
            }
        }, function(error) {
            clearTimeout(monacoTimeout);
            console.error('‚ùå Failed to load Monaco from CDN:', error);
            createFallbackEditor();
        });
        
        // Fallback editor function for A-Frame
        function createFallbackEditor() {
            console.log('üîß Creating fallback textarea editor for A-Frame...');
            
            const editorContainer = document.getElementById('monaco-editor');
            if (!editorContainer) {
                console.error('‚ùå Editor container not found');
                return;
            }
            
            // Create a textarea fallback
            editorContainer.innerHTML = '<textarea id="fallback-editor" style="width: 100%; height: 100%; background: #1e1e1e; color: #fff; font-family: \'Monaco\', \'Consolas\', monospace; font-size: 14px; border: none; outline: none; padding: 10px;"></textarea>';
            
            const textarea = document.getElementById('fallback-editor');
            if (textarea) {
                textarea.value = getDefaultCode();
                
                // Create minimal editor interface
                window.editor = {
                    setValue: (code) => { textarea.value = code; },
                    getValue: () => textarea.value,
                    getModel: () => ({ setValue: (code) => textarea.value = code }),
                    layout: () => {},
                    focus: () => textarea.focus(),
                    setPosition: () => {},
                    onDidChangeModelContent: (callback) => {
                        textarea.addEventListener('input', callback);
                        return { dispose: () => {} };
                    }
                };
                
                window.monacoEditor = window.editor;
                window.codeEditor = window.editor;
                
                // Auto-save on changes
                textarea.addEventListener('input', () => {
                    debounce(notifyCodeChange, 500)();
                });
                
                // Mark as ready
                window.editorReady = true;
                console.log('‚úÖ Fallback editor ready for injection');
                
                // Initialize A-Frame
                initializeAFrame();
            }
        }
        
        // Initialize A-Frame
        function initializeAFrame() {
            console.log('Initializing A-Frame...');
            
            // Hide loading
            document.getElementById('loading').style.display = 'none';
            
            // Create default scene
            createDefaultScene();
            
            console.log('A-Frame initialization complete');
            
            // Notify Swift that initialization is complete
            setTimeout(() => {
                console.log('A-Frame playground fully initialized');
                notifySwift('initializationComplete', { 
                    ready: true,
                    editorReady: !!(window.editorReady && typeof editor !== 'undefined' && editor),
                    engineReady: true // A-Frame is always ready once loaded
                });
            }, 1500);
        }
        
        function getDefaultCode() {
            return `<!-- Welcome to A-Frame VR Playground! -->
<!-- Create immersive VR/AR scenes using A-Frame -->

<a-scene embedded vr-mode-ui="enabled: true" background="color: #212">
    <!-- Assets -->
    <a-assets>
        <!-- Add textures, models, sounds here -->
    </a-assets>
    
    <!-- Lighting -->
    <a-light type="ambient" color="#404040" intensity="0.6"></a-light>
    <a-light type="directional" position="10 10 5" color="#ffffff" intensity="0.8"></a-light>
    
    <!-- 3D Objects -->
    <a-sphere 
        position="0 2 -5" 
        radius="1" 
        color="#ff6b6b"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
    </a-sphere>
    
    <a-box 
        position="-2 1 -3" 
        rotation="0 45 0" 
        color="#4ecdc4"
        animation="property: position; to: -2 2 -3; direction: alternate; loop: true; dur: 2000">
    </a-box>
    
    <a-cylinder 
        position="2 1 -3" 
        radius="0.5" 
        height="2" 
        color="#ffe66d">
    </a-cylinder>
    
    <!-- Ground -->
    <a-plane 
        position="0 0 -4" 
        rotation="-90 0 0" 
        width="20" 
        height="20" 
        color="#95e1d3"
        shadow="receive: true">
    </a-plane>
    
    <!-- Interactive text -->
    <a-text 
        value="Welcome to A-Frame!" 
        position="0 3 -2" 
        align="center" 
        color="#fff"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 8000">
    </a-text>
    
    <!-- VR Camera with controls -->
    <a-camera 
        look-controls 
        wasd-controls 
        position="0 1.6 3"
        animation="property: position; to: 0 1.6 8; startEvents: click; dur: 3000">
        <a-cursor 
            color="#fff" 
            raycaster="objects: [clickable]">
        </a-cursor>
    </a-camera>
</a-scene>`;
        }
        
        function createDefaultScene() {
            try {
                // Execute user code
                const userCode = editor ? editor.getValue() : getDefaultCode();
                executeUserCode(userCode);
                
                hideError();
            } catch (error) {
                showError('Scene Creation Error: ' + error.message);
                console.error('Scene creation error:', error);
            }
        }
        
        function executeUserCode(code) {
            try {
                console.log('=== EXECUTING A-FRAME USER CODE ===');
                
                clearConsole();
                clearScene();
                
                // Create new A-Frame scene from HTML
                const container = document.getElementById('aframe-container');
                container.innerHTML = code;
                
                // Wait for A-Frame to initialize the scene
                setTimeout(() => {
                    currentScene = container.querySelector('a-scene');
                    if (currentScene) {
                        console.log('‚úÖ A-Frame scene created successfully');
                        hideError();
                        notifySwift('sceneCreated', { success: true });
                    } else {
                        throw new Error('No a-scene element found in code');
                    }
                }, 500);
                
            } catch (error) {
                const errorMsg = 'Execution Error: ' + error.message;
                console.error('‚ùå executeUserCode failed:', errorMsg);
                showError(errorMsg);
                notifySwift('sceneError', { error: error.message });
                
                // Create fallback scene
                createFallbackScene();
            }
        }
        
        function clearScene() {
            const container = document.getElementById('aframe-container');
            if (container) {
                container.innerHTML = '<div class="loading" id="loading" style="display: none;">Loading A-Frame...</div>';
            }
        }
        
        function createFallbackScene() {
            console.log('Creating A-Frame fallback scene');
            const container = document.getElementById('aframe-container');
            container.innerHTML = `
                <a-scene embedded background="color: #333">
                    <a-light type="ambient" color="#404040"></a-light>
                    <a-box position="0 1 -3" color="#00ff00"></a-box>
                    <a-camera look-controls wasd-controls position="0 1.6 0">
                        <a-cursor color="#fff"></a-cursor>
                    </a-camera>
                </a-scene>
            `;
        }
        
        // Playground functions
        function runCode() {
            console.log('Run code button pressed');
            createDefaultScene();
            notifySwift('codeRun', {});
        }
        
        function formatCode() {
            if (editor) {
                editor.getAction('editor.action.formatDocument').run();
                notifySwift('codeFormatted', {});
            }
        }
        
        function clearCode() {
            if (editor) {
                editor.setValue(getDefaultCode());
                notifySwift('codeCleared', {});
            }
        }
        
        function saveScene() {
            const code = editor ? editor.getValue() : '';
            notifySwift('saveRequested', { code: code });
        }
        
        function downloadScene() {
            const code = editor ? editor.getValue() : '';
            notifySwift('downloadRequested', { code: code });
        }
        
        function newScene() {
            clearCode();
            runCode();
        }
        
        function showExamples() {
            notifySwift('showExamples', {});
        }
        
        function initFloatingConsole() {
            const consoleWindow = document.getElementById('consoleWindow');
            const titleBar = document.getElementById('consoleTitleBar');
            const minimizeBtn = document.getElementById('consoleMinimizeBtn');
            const toggleBtn = document.getElementById('consoleToggleBtn');
            const closeBtn = document.getElementById('consoleCloseBtn');
            const resizeHandle = document.getElementById('consoleResizeHandle');
            const consoleOpenBtn = document.getElementById('consoleOpenBtn');

            // Safety check - return if elements don't exist yet
            if (!consoleWindow || !titleBar || !minimizeBtn || !toggleBtn || !closeBtn || !resizeHandle || !consoleOpenBtn) {
                console.warn('Console elements not ready yet, skipping initialization');
                return;
            }

            // Load saved state from localStorage
            const saved = localStorage.getItem('aframe_console_state');
            if (saved) {
                consoleState = { ...consoleState, ...JSON.parse(saved) };
                applyConsoleState();
            }

            // Minimize button
            minimizeBtn.addEventListener('click', () => {
                consoleState.minimized = !consoleState.minimized;
                consoleWindow.classList.toggle('minimized', consoleState.minimized);
                minimizeBtn.textContent = consoleState.minimized ? '+' : '‚àí';
                saveConsoleState();
            });

            // Toggle/Expand button
            toggleBtn.addEventListener('click', () => {
                if (consoleState.minimized) {
                    consoleState.minimized = false;
                    consoleWindow.classList.remove('minimized');
                    minimizeBtn.textContent = '‚àí';
                }
                saveConsoleState();
            });

            // Close button
            closeBtn.addEventListener('click', () => {
                consoleState.hidden = true;
                consoleWindow.classList.add('hidden');
                saveConsoleState();
                updateConsoleOpenButtonVisibility();
            });

            // Dragging
            let isDragging = false;
            let dragStartX, dragStartY, dragStartLeft, dragStartTop;

            titleBar.addEventListener('mousedown', startDrag);
            titleBar.addEventListener('touchstart', startDrag, { passive: false });

            function startDrag(e) {
                if (e.target.closest('.console-btn')) return;
                isDragging = true;

                const rect = consoleWindow.getBoundingClientRect();
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                dragStartX = clientX;
                dragStartY = clientY;
                dragStartLeft = rect.left;
                dragStartTop = rect.top;

                e.preventDefault();
            }

            function doDrag(e) {
                if (!isDragging) return;

                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                const deltaX = clientX - dragStartX;
                const deltaY = clientY - dragStartY;

                consoleState.x = dragStartLeft + deltaX;
                consoleState.y = dragStartTop + deltaY;

                consoleWindow.style.left = consoleState.x + 'px';
                consoleWindow.style.top = consoleState.y + 'px';
                consoleWindow.style.right = 'auto';
                consoleWindow.style.bottom = 'auto';

                e.preventDefault();
            }

            function stopDrag() {
                if (isDragging) {
                    isDragging = false;
                    saveConsoleState();
                }
            }

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('touchmove', doDrag, { passive: false });
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchend', stopDrag);

            // Resizing
            let isResizingConsole = false;
            let resizeStartX, resizeStartY, resizeStartWidth, resizeStartHeight;

            resizeHandle.addEventListener('mousedown', startResize);
            resizeHandle.addEventListener('touchstart', startResize, { passive: false });

            function startResize(e) {
                isResizingConsole = true;

                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                resizeStartX = clientX;
                resizeStartY = clientY;
                resizeStartWidth = consoleWindow.offsetWidth;
                resizeStartHeight = consoleWindow.offsetHeight;

                e.preventDefault();
                e.stopPropagation();
            }

            function doResize(e) {
                if (!isResizingConsole) return;

                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                const deltaX = clientX - resizeStartX;
                const deltaY = clientY - resizeStartY;

                consoleState.width = Math.max(300, Math.min(resizeStartWidth + deltaX, window.innerWidth * 0.9));
                consoleState.height = Math.max(200, Math.min(resizeStartHeight + deltaY, window.innerHeight * 0.8));

                consoleWindow.style.width = consoleState.width + 'px';
                consoleWindow.style.height = consoleState.height + 'px';

                e.preventDefault();
            }

            function stopResize() {
                if (isResizingConsole) {
                    isResizingConsole = false;
                    saveConsoleState();
                }
            }

            document.addEventListener('mousemove', doResize);
            document.addEventListener('touchmove', doResize, { passive: false });
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchend', stopResize);

            // Console Open Button (already declared at top of function)
            consoleOpenBtn.addEventListener('click', () => {
                consoleState.hidden = false;
                consoleState.minimized = false;
                consoleWindow.classList.remove('hidden');
                consoleWindow.classList.remove('minimized');
                minimizeBtn.textContent = '‚àí';
                saveConsoleState();
                updateConsoleOpenButtonVisibility();
            });

            // Update button visibility based on console state
            updateConsoleOpenButtonVisibility();
        }

        function updateConsoleOpenButtonVisibility() {
            const consoleOpenBtn = document.getElementById('consoleOpenBtn');
            const consoleWindow = document.getElementById('consoleWindow');

            // Show button only when console is hidden
            if (consoleState.hidden) {
                consoleOpenBtn.classList.remove('hidden');
            } else {
                consoleOpenBtn.classList.add('hidden');
            }
        }

        function applyConsoleState() {
            const consoleWindow = document.getElementById('consoleWindow');
            const minimizeBtn = document.getElementById('consoleMinimizeBtn');

            if (consoleState.x !== null && consoleState.y !== null) {
                consoleWindow.style.left = consoleState.x + 'px';
                consoleWindow.style.top = consoleState.y + 'px';
                consoleWindow.style.right = 'auto';
                consoleWindow.style.bottom = 'auto';
            }

            consoleWindow.style.width = consoleState.width + 'px';
            consoleWindow.style.height = consoleState.height + 'px';

            consoleWindow.classList.toggle('minimized', consoleState.minimized);
            consoleWindow.classList.toggle('hidden', consoleState.hidden);
            minimizeBtn.textContent = consoleState.minimized ? '+' : '‚àí';

            updateConsoleOpenButtonVisibility();
        }

        function saveConsoleState() {
            localStorage.setItem('aframe_console_state', JSON.stringify(consoleState));
        }

        function toggleConsole() {
            consoleState.hidden = !consoleState.hidden;
            document.getElementById('consoleWindow').classList.toggle('hidden', consoleState.hidden);
            saveConsoleState();
            updateConsoleOpenButtonVisibility();
            if (!consoleState.hidden && consoleMessages.length === 0) {
                console.log('Console opened - no messages yet');
            }
        }

        // Initialize console on page load
        window.addEventListener('DOMContentLoaded', initFloatingConsole);

        function loadExample(exampleId) {
            if (!exampleId) return;
            
            const examples = {
                'basic-vr': getDefaultCode(),
                'interactive': getInteractiveCode(),
                'animation': getAnimationCode(),
                'vr-controls': getVRControlsCode()
            };
            
            if (examples[exampleId] && editor) {
                editor.setValue(examples[exampleId]);
                runCode();
            }
        }
        
        // Enhanced code insertion functions with multi-level fallback
        function insertCodeAtCursor(codeString) {
            console.log('üéØ A-Frame insertCodeAtCursor called with code length:', codeString.length);
            console.log('üîç A-Frame editor readiness:', {
                editor: !!editor,
                editorReady: !!window.editorReady,
                monacoLoaded: typeof monaco !== 'undefined'
            });
            
            if (editor && window.editorReady) {
                try {
                    console.log('‚úÖ A-Frame editor ready, inserting at cursor');
                    const position = editor.getPosition();
                    editor.executeEdits('ai-insertion', [{
                        range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
                        text: codeString
                    }]);
                    editor.setPosition(position);
                    editor.focus();
                    console.log('‚úÖ A-Frame code inserted at cursor position');
                    notifySwift('codeInserted', { code: codeString, library: 'aframe' });
                    return true;
                } catch (error) {
                    console.error('‚ùå A-Frame failed to insert at cursor:', error);
                    // Fall back to setFullEditorContent
                    return setFullEditorContent(codeString);
                }
            } else {
                console.warn('‚ö†Ô∏è A-Frame editor not ready for cursor insertion, falling back to full content replacement');
                return setFullEditorContent(codeString);
            }
        }
        
        function setFullEditorContent(codeString) {
            console.log('üéØ A-Frame setFullEditorContent called with code length:', codeString.length);
            console.log('üîç A-Frame editor state check:', {
                editorExists: !!editor,
                editorReady: !!window.editorReady,
                domReady: document.readyState,
                monacoGlobal: typeof monaco !== 'undefined'
            });
            
            // Multi-level injection strategy for A-Frame
            const strategies = [
                // Strategy 1: Standard Monaco API
                () => {
                    if (editor && window.editorReady && typeof editor.setValue === 'function') {
                        console.log('üìù A-Frame Strategy 1: Using standard Monaco setValue');
                        editor.setValue(codeString);
                        editor.focus();
                        editor.setPosition({lineNumber: 1, column: 1});
                        editor.layout();
                        
                        // Verify content was set
                        const verification = editor.getValue();
                        if (verification === codeString) {
                            console.log('‚úÖ A-Frame Strategy 1 successful - content verified');
                            return true;
                        } else {
                            console.warn('‚ö†Ô∏è A-Frame Strategy 1 verification failed');
                            return false;
                        }
                    }
                    return false;
                },
                
                // Strategy 2: Direct model manipulation
                () => {
                    if (editor && editor.getModel && typeof editor.getModel === 'function') {
                        console.log('üìù A-Frame Strategy 2: Using Monaco model setValue');
                        const model = editor.getModel();
                        if (model && typeof model.setValue === 'function') {
                            model.setValue(codeString);
                            editor.focus();
                            console.log('‚úÖ A-Frame Strategy 2 successful - model setValue');
                            return true;
                        }
                    }
                    return false;
                },
                
                // Strategy 3: Emergency retry with delay
                () => {
                    return new Promise((resolve) => {
                        console.log('üìù A-Frame Strategy 3: Emergency retry with delay');
                        setTimeout(() => {
                            if (editor && typeof editor.setValue === 'function') {
                                try {
                                    editor.setValue(codeString);
                                    console.log('‚úÖ A-Frame Strategy 3 successful - delayed retry');
                                    resolve(true);
                                } catch (e) {
                                    console.error('‚ùå A-Frame Strategy 3 failed:', e);
                                    resolve(false);
                                }
                            } else {
                                resolve(false);
                            }
                        }, 1000);
                    });
                }
            ];
            
            // Try each strategy sequentially
            const executeStrategies = async () => {
                for (let i = 0; i < strategies.length; i++) {
                    try {
                        const result = await strategies[i]();
                        if (result) {
                            console.log(`üéâ A-Frame content injection successful using strategy ${i + 1}`);
                            
                            // Auto-run the code after successful injection
                            setTimeout(() => {
                                console.log('üöÄ Auto-running the injected A-Frame code...');
                                runCode();
                            }, 500);
                            
                            notifySwift('codeInserted', { 
                                code: codeString,
                                strategy: i + 1,
                                success: true,
                                library: 'aframe'
                            });
                            return true;
                        }
                    } catch (error) {
                        console.error(`‚ùå A-Frame Strategy ${i + 1} failed:`, error);
                    }
                }
                
                console.error('‚ùå All A-Frame injection strategies failed');
                notifySwift('codeInserted', { 
                    code: codeString,
                    success: false,
                    error: 'All A-Frame injection strategies failed',
                    library: 'aframe'
                });
                return false;
            };
            
            return executeStrategies();
        }
        
        // Utility functions
        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            setTimeout(() => {
                errorDisplay.style.display = 'none';
            }, 5000);
        }
        
        function hideError() {
            document.getElementById('errorDisplay').style.display = 'none';
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function notifySwift(action, data) {
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.playgroundHandler) {
                window.webkit.messageHandlers.playgroundHandler.postMessage({
                    action: action,
                    data: data
                });
            }
        }
        
        function notifyCodeChange() {
            const code = editor ? editor.getValue() : '';
            notifySwift('codeChanged', { code: code });
        }
        
        // Console management
        function addConsoleMessage(type, message) {
            consoleMessages.push({ type, message, timestamp: Date.now() });
            if (consoleMessages.length > 50) {
                consoleMessages = consoleMessages.slice(-50);
            }
            updateConsoleDisplay();
        }
        
        function updateConsoleDisplay() {
            const consoleContent = document.getElementById('consoleContent');
            if (consoleContent && consoleMessages.length > 0) {
                consoleContent.innerHTML = consoleMessages.map(msg =>
                    `<div class="console-message console-${msg.type}">${escapeHtml(msg.message)}</div>`
                ).join('');
                consoleContent.scrollTop = consoleContent.scrollHeight;
            }
        }
        
        function clearConsole() {
            consoleMessages = [];
            updateConsoleDisplay();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Example code templates
        function getInteractiveCode() {
            return `<a-scene embedded vr-mode-ui="enabled: true" background="color: #212">
    <a-assets>
        <!-- Define clickable class for cursor interaction -->
    </a-assets>
    
    <a-light type="ambient" color="#404040" intensity="0.6"></a-light>
    <a-light type="directional" position="10 10 5" color="#ffffff" intensity="0.8"></a-light>
    
    <!-- Interactive spheres that change color on click -->
    <a-sphere 
        position="-2 1.5 -3" 
        radius="0.8" 
        color="#ff6b6b"
        class="clickable"
        animation__click="property: color; to: #00ff00; startEvents: click; dur: 500">
    </a-sphere>
    
    <a-sphere 
        position="0 1.5 -3" 
        radius="0.8" 
        color="#4ecdc4"
        class="clickable"
        animation__click="property: scale; to: 1.5 1.5 1.5; startEvents: click; dur: 1000; direction: alternate">
    </a-sphere>
    
    <a-sphere 
        position="2 1.5 -3" 
        radius="0.8" 
        color="#ffe66d"
        class="clickable"
        animation__click="property: rotation; to: 0 360 0; startEvents: click; dur: 2000">
    </a-sphere>
    
    <!-- Ground -->
    <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#95e1d3"></a-plane>
    
    <!-- Instructions -->
    <a-text 
        value="Click the spheres!" 
        position="0 3 -2" 
        align="center" 
        color="#fff">
    </a-text>
    
    <a-camera look-controls wasd-controls position="0 1.6 0">
        <a-cursor 
            color="#fff" 
            raycaster="objects: .clickable">
        </a-cursor>
    </a-camera>
</a-scene>`;
        }
        
        function getAnimationCode() {
            return `<a-scene embedded vr-mode-ui="enabled: true" background="color: #001122">
    <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
    <a-light type="directional" position="10 10 5" color="#ffffff" intensity="0.8"></a-light>
    
    <!-- Floating and rotating objects -->
    <a-box 
        position="-3 2 -5" 
        color="#ff6b6b"
        animation="property: rotation; to: 360 360 0; loop: true; dur: 4000"
        animation__float="property: position; to: -3 3 -5; direction: alternate; loop: true; dur: 2000">
    </a-box>
    
    <a-sphere 
        position="0 1 -4" 
        radius="1.2" 
        color="#4ecdc4"
        animation="property: scale; to: 1.5 1.5 1.5; direction: alternate; loop: true; dur: 2000"
        animation__color="property: color; to: #ff6b6b; direction: alternate; loop: true; dur: 3000">
    </a-sphere>
    
    <a-cylinder 
        position="3 1 -5" 
        radius="0.8" 
        height="2" 
        color="#ffe66d"
        animation="property: position; to: 3 3 -5; direction: alternate; loop: true; dur: 1500"
        animation__spin="property: rotation; to: 0 0 360; loop: true; dur: 2000">
    </a-cylinder>
    
    <!-- Pulsing lights -->
    <a-light 
        type="point" 
        position="-3 4 -3" 
        color="#ff0000"
        animation="property: intensity; to: 2; direction: alternate; loop: true; dur: 1000">
    </a-light>
    
    <a-light 
        type="point" 
        position="3 4 -3" 
        color="#0000ff"
        animation="property: intensity; to: 2; direction: alternate; loop: true; dur: 1500">
    </a-light>
    
    <!-- Animated ground -->
    <a-plane 
        position="0 0 -4" 
        rotation="-90 0 0" 
        width="20" 
        height="20" 
        color="#2d5a27"
        animation="property: color; to: #5a2d27; direction: alternate; loop: true; dur: 4000">
    </a-plane>
    
    <a-text 
        value="Animated VR Scene" 
        position="0 4 -3" 
        align="center" 
        color="#fff"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
    </a-text>
    
    <a-camera look-controls wasd-controls position="0 1.6 2">
        <a-cursor color="#fff"></a-cursor>
    </a-camera>
</a-scene>`;
        }
        
        function getVRControlsCode() {
            return `<a-scene embedded vr-mode-ui="enabled: true" background="color: #001122">
    <a-assets>
        <!-- VR controller models will be loaded automatically -->
    </a-assets>
    
    <a-light type="ambient" color="#404040" intensity="0.6"></a-light>
    <a-light type="directional" position="10 10 5" color="#ffffff" intensity="0.8"></a-light>
    
    <!-- Interactive objects for VR controllers -->
    <a-box 
        position="-2 1 -3" 
        color="#ff6b6b"
        class="interactive"
        animation__grab="property: scale; to: 1.2 1.2 1.2; startEvents: gripdown; dur: 200"
        animation__release="property: scale; to: 1 1 1; startEvents: gripup; dur: 200">
    </a-box>
    
    <a-sphere 
        position="0 1 -3" 
        radius="0.8" 
        color="#4ecdc4"
        class="interactive">
    </a-sphere>
    
    <a-cylinder 
        position="2 1 -3" 
        radius="0.5" 
        height="1.5" 
        color="#ffe66d"
        class="interactive">
    </a-cylinder>
    
    <!-- Ground -->
    <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#95e1d3"></a-plane>
    
    <!-- Instructions -->
    <a-text 
        value="Use VR controllers to interact!" 
        position="0 2.5 -2" 
        align="center" 
        color="#fff">
    </a-text>
    
    <!-- VR Camera rig with hand controls -->
    <a-entity id="cameraRig" position="0 0 0">
        <a-camera 
            look-controls 
            wasd-controls="enabled: false" 
            position="0 1.6 0">
        </a-camera>
        
        <!-- Left hand controller -->
        <a-entity 
            id="leftHand"
            hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"
            laser-controls="hand: left"
            raycaster="objects: .interactive">
        </a-entity>
        
        <!-- Right hand controller -->
        <a-entity 
            id="rightHand"
            hand-controls="hand: right; handModelStyle: lowPoly; color: #ccffcc"
            laser-controls="hand: right"
            raycaster="objects: .interactive">
        </a-entity>
    </a-entity>
</a-scene>`;
        }
    </script>
</body>
</html>